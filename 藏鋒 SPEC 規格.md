# 藏鋒 SPEC 規格

<aside>
💡

外部待討論：

1. 請提供API可查詢的資訊欄位，是否有 [產業大類、產業中類、產品組合、產品占比] 等欄位，或其它更好的欄位
2. 雲端 或 伺服器？
</aside>

### 功能描述

**撈取兩種技術型態的個股資料**

A. VCP 強勢股

B. 三線開花

主檔資料

1. **每月**排程撈取 台股上市櫃 (不含興櫃、創版) 所有個股總表，作為主檔。(**API-1**)
2. **每月**排程撈取 美股 所有個股 總表，作為主檔。(**API-3**)

A. 強勢股 (檔名為 台股VCP追踪、美股VCP追踪)

1. **每日**盤後，排程打 API 取得台股 (**API-2**)、美股 (**API-4**) 的個股股價數據，須扣除ETF等其它商品。
2. **API-5**  撈取資料(計算及暫存): 台股及美股 近20日大盤漲跌幅 (分成2個temp)

B. 三線開花

1. **每日**盤後，排程打 API 取得台股 (**API-2**)、美股 (**API-4**) 的個股股價數據，須扣除ETF等其它商品。

### 規格需求

1. API 排程固定更新至 5 個google sheet檔案，檔名分別如下
    1. 公司主檔：
        1. 第一個分頁名稱為”台股公司主檔”、第二個分頁名稱 ”台股更新紀錄”
        2. 第三個分頁名稱為”美股公司主檔”、第四個分頁名稱 ”美股更新紀錄”
    2. 台股VCP：每日取得資料後存成分頁名 “YYMMDD”
    3. 美股VCP：每日取得資料後存成分頁名 “YYMMDD”
    4. 台股三線開花：每日取得資料後存成分頁名 “YYMMDD”
    5. 美股三線開花：每日取得資料後存成分頁名 “YYMMDD”
2. 公司主檔：
    1. **API-1** 撈取目前所有上市櫃的台股公司資訊，固定更新在第一個分頁，分頁名”台股公司主檔”，可作**差集後插入(Insert)**。
        1. 欄位標題：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合]，無資料就請填 ”-”
        2. 首次建立 ”台股公司主檔” 分頁，第二次後不建立分頁，固定在同一分頁動作。首次撈取依代號的升冪排序、第二次後採差集後插入
        3. “台股公司主檔”更新後，請在分頁二  ”台股更新紀錄” 的A1 欄位寫入更新時間
    2. **API-3** 撈取目前所有美股公司資訊，固定更新在第一個分頁，分頁名”美股公司主檔”，可作**差集後插入(Insert)**。
        1. 欄位標題：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合]，無資料就請填 ”-”
        2. 首次建立 ”美股公司主檔” 分頁，第二次後不建立分頁，固定在同一分頁動作。首次撈取依代號的升冪排序、第二次後採差集後插入
        3. “美股公司主檔”更新後，請在分頁二  ”美股更新紀錄” 的A1 欄位寫入更新時間
3. 台股VCP：
    1. **API-5** 計算及暫存 近20日大盤漲跌幅 (**temp value**)
    2. **API-2** 產出台股個股價資料，新增分頁名 “YYMMDD”，固定插入在第二個分頁
        1. 第一個比對邏輯的三個條件(強勢清單)
            1. 個股今日收盤股價 > 50日均價 > 150日均價 > 200日均價
            2. 近200天均價 大於 20天前的200日均價
            3. 個股的 近20日個股漲跌幅 大於 大盤近20日漲跌幅 (**temp value**)
            4. 同時滿足 3 個條件作為第 1 個 Temp **(第一個條件判斷式)**
        2. 第二個比對邏輯的二個條件 (新高清單)
            1. 個股近 5 日最高股價 約等於 近 52 週最高價 (兩者正負差距為 1% 內) 
            2. 個股的 近20日個股漲跌幅 大於 大盤近20日漲跌幅 (**temp value**)
            3. 同時滿足 2 個條件作為第 2 個 Temp **(第二個條件判斷式)**
        3. 合併 第一和第二的條件判斷式作資料聯集
        4. Google Sheet的資料格式：標題列 [代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、近20日股價漲幅、強勢清單、新高清單]
        5. 符合第一個條件判斷式請在強勢清單註記 O、符合第二個條件判斷式請在新高清單註記 O
        6. 資料排序依 “近20日股價漲幅” 降冪排序
4. 美股VCP：
    1. **API-5** 計算及暫存 近20日大盤漲跌幅 (**temp value**)
    2. **API-4** 產出美股個股價資料，新增分頁名 “YYMMDD”，固定插入在第二個分頁
        1. 第一個比對邏輯的三個條件(強勢清單)
            1. 個股今日收盤股價 > 50日均價 > 150日均價 > 200日均價
            2. 近200天均價 大於 20天前的200日均價
            3. 個股的 近20日個股漲跌幅 大於 大盤近20日漲跌幅 (**temp value**)
            4. 同時滿足 3 個條件作為第 1 個 Temp **(第一個條件判斷式)**
        2. 第二個比對邏輯的二個條件 (新高清單)
            1. 個股近 5 日最高股價 約等於 近 52 週最高價 (兩者正負差距為 1% 內) 
            2. 個股的 近20日個股漲跌幅 大於 大盤近20日漲跌幅 (**temp value**)
            3. 同時滿足 2 個條件作為第 2 個 Temp **(第二個條件判斷式)**
        3. 合併 第一和第二的條件判斷式作資料聯集
        4. Google Sheet的資料格式：標題列 [代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、近20日股價漲幅、強勢清單、新高清單]
        5. 符合第一個條件判斷式請在強勢清單註記 O、符合第二個條件判斷式請在新高清單註記 O
        6. 資料排序依 “近20日股價漲幅” 降冪排序
5. 台股三線開花：
    1. **API-2** 產出台股個股價資料，新增分頁名 “YYMMDD”，固定插入在第二個分頁
        1. 比對邏輯的三個條件
            1. 個股今日收盤股價 > 8 日均價 > 21 日均價 > 55 日均價
            2. 個股今日收盤股價 為 55 日內的最高價
        2. Google Sheet的資料格式：標題列 [代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、今日股價、55日內次高價、差距比例]
        3. 差距比例公式 = （今日股價 / 55日內次高價）-1
        4. 資料排序依 “差距比例” 降冪排序
6. 美股三線開花：
    1. **API-4** 產出美股個股價資料，新增分頁名 “YYMMDD”，固定插入在第二個分頁
        1. 比對邏輯的三個條件
            1. 個股今日收盤股價 > 8 日均價 > 21 日均價 > 55 日均價
            2. 個股今日收盤股價 為 55 日內的最高價
        2. Google Sheet的資料格式：標題列 [代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、今日股價、55日內次高價、差距比例]
        3. 差距比例公式 = （今日股價 / 55日內次高價）-1
        4. 資料排序依 “差距比例” 降冪排序

### 錯誤檢查

針對API 的 HTTP Response code，應採取個別處理

1. 不可重試錯誤- 4XX
    
    當收到 4XX 類錯誤（除 429 外）時，代表請求內容有誤或權限過期。
    
    - **關鍵狀態碼**：`400 Bad Request`、`401 Unauthorized`、`403 Forbidden`、`404 Not Found`。
    - **處理邏輯**：
        1. **立即中斷**：禁止自動重試。
        2. **異常拋出**：觸發告警並記錄 Error Log，人工接手修復。
2. 可重試錯誤- 5XX & 429
    
    當收到暫時性的伺服器問題時，應啟動重試機制。
    
    - 關鍵狀態碼：`500 Internal Error`、`503 Service Unavailable`、`504 Gateway Timeout`、`429 Too Many Requests`。
    - 處理邏輯：進入重試排程。
3. 重試時間：第 1 次 5 分鐘後、第 2 次 10 分鐘後、第 3 次1 小時後
4. 最大重試次數：3次，但應可從設定檔 (txt) 調整。
5. Log 紀錄：每次重試皆須記錄 `Time`,`Retry_Count` 與 `Last_Error_Code` 以利後續追蹤排錯，紀錄在第二個分頁名稱 ”台股更新紀錄”和”美股更新紀錄”。

### 輸出成品

五個固定的google sheet檔案，檔名為公司主檔、台股VCP、美股VCP、台股三線開花、美股三線開花，分頁描述如下

檔名：公司主檔

1. 台股公司主檔：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合]
2. 台股更新紀錄
3. 美股公司主檔：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合]
4. 美股更新紀錄

檔名：台股VCP

1. YYMMDD ：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、近20日股價漲幅、強勢清單、新高清單]

檔名：美股VCP

1. YYMMDD ：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、近20日股價漲幅、強勢清單、新高清單]

檔名：台股三線開花

1. YYMMDD：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、今日股價、55日內次高價、差距比例]

檔名：美股三線開花

1. YYMMDD：[代號、股名、公司名、產業分類1、產業分類2(option)、產品組合、今日股價、55日內次高價、差距比例]